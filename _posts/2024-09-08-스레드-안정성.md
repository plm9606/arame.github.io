---
title: 스레드 안정성
categories: [jvm]
tags: [jvm, cs, jvm밑바닥까지파해치기, thread]
author: aram
toc: true
comment: true
---
스레드 안전성은 여러 스레드가 동시에 접근할 때도 프로그램이 올바르게 동작하는 것을 의미한다. 스레드 안전성이 보장되지 않으면 데이터 무결성이 깨지거나 예상치 못한 동작이 발생할 수 있다.

엄격한 정의

여러 스레드가 한 객체에 동시에 접근할 때, 어떤 런타임 환경에서든 다음 두 조건을 모두 충족하면서 객체를 호출하는 행위가 올바른 결과를 얻을 수 있다면, 그 객체는 스레드 안전하다 라고 말한다. 
- 특별한 스레드 스케줄링이나 대체 실행 수단을 고려할 필요가 없다
- 추가적인 동기화 수단이나 호출자 측에서 조율이 필요 없다. 


### 중요한 이유
동시성 프로그래밍에서 **여러 스레드가 동시에 자원에 접근할 경우** 스레드 안전성이 매우 중요하다. 스레드 안전성을 보장하지 않으면, 경쟁 조건, 데드락, 라이브락과 같은 문제가 발생할 수 있다. 스레드 안전성을 확보해 데이터 무결성과 시스템의 안정성을 유지해야 한다.

- 경쟁 조건(race condition)
    - 두 개 이상의 스레드가 동일한 자원에 동시에 접근하여 변경할 때 발생. 예를 들어, 두 스레드가 같은 변수의 값을 읽고, 그 값을 기반으로 다른 값을 기록하는 경우, 결과는 예측할 수 없게 된다.
- Deadlock
    - 두 개 이상의 스레드가 서로의 자원을 기다리면서 영원히 대기 상태에 빠지는 상황
- Livelock
    - 두 개 이상의 스레드가 계속해서 서로의 작업을 방해하여 실제로 아무 작업도 진척되지 않는 상태. 데드락과 유사하지만, 스레드가 계속해서 상태를 변경한다는 점이 다르다.


### 스레드 안정성을 보장하는 방법
1. 락
    - 뮤텍스
    - 읽기/쓰기 락
2. 세마포어
3. 모니터
   - 자바의 `synchronized`
4. 원자적 연산
    - 자바의 `AtomicInteger`
5. 불변 객체
6. 스레드 로컬 저장소
    - 각 스레드가 자신의 독립적인 자원에 접근하도록 하는 방법입. 스레드 간에 데이터를 공유하지 않기 때문에 스레드 안전성을 쉽게 달성할 수 있다.

## 자바 언어의 스레드 안정성
### 동기화 방법
1. 상호 배제 동기화
블로킹 동기화
2. 논블로킹 동기화

### JVM의 락 최적화 방법
이 기법들은 자바 가상 머신(JVM)에 의해 내부적으로 관리되므로, 개발자가 명시적으로 설정하지 않아도 적절한 상황에서 자동으로 적용된다. 이러한 최적화 기법을 이해하면 프로그램의 성능 향상에 도움이 될 수 있다.
멀티스레드 환경에서 락 관련 오버헤드를 줄이기 위한 자바의 최적화 기법

- 스핀락
JDK6부터 기본으로 활성화. JDK6에서는 스핀락을 최적화한 적응형 스핀을 도입했다.

- 락 제거
특정 코드 조각에서 런타임에 데이터 경합이 일어나지 않는다고 판단되면 가상 머신의 jit컴파일러가 해당 락을 제거하는 최적화 기법.
개발자가 명시적으로 거는 락 외에도 실제 자바 프로그램에는 동기화 장치가 많이 쓰인다. 그래서 동기화 코드의 실제 빈도는 개발자의 상상을 초월한다. 

- 락 확장
    - 경량 락
        - 락 획득/해제의 오버헤드 줄이기 위해
        - cas연산을 활용해 뮤텍스 사용(오버헤드) 피함
        - 빠른 락 획득/해제, 스핀 락 메커니즘 사용
        - 여러놈이 찔끔찔끔 자원 필요로 하는 경우

    - 편향 락 (Biased Locking)
        - 스레드가 장기간 자원을 독점하는 경우 락 획득/해제 오버헤드를 최소화하기 위해
        - 특정 스레드에 락이 편향되어 해당 스레드가 락을 필요로 할 때 락 획득 절차 생략
        - 한놈이 반복적으로 장기적으로 자원 독점하는 경우

